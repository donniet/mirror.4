<!doctype html>
<html>
<head>
  <title>Mirror</title>
  <style type="text/css">
  /* arabic */
  @font-face {
    font-family: 'Cairo';
    font-style: normal;
    font-weight: 400;
    src: local('Cairo'), local('Cairo-Regular'), url(client/fonts/Cairo-Regular-Arabic.woff2) format('woff2');
    unicode-range: U+0600-06FF, U+200C-200E, U+2010-2011, U+204F, U+2E41, U+FB50-FDFF, U+FE80-FEFC;
  }
  /* latin-ext */
  @font-face {
    font-family: 'Cairo';
    font-style: normal;
    font-weight: 400;
    src: local('Cairo'), local('Cairo-Regular'), url(client/fonts/Cairo-Regular-Latin-Ext.woff2) format('woff2');
    unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  /* latin */
  @font-face {
    font-family: 'Cairo';
    font-style: normal;
    font-weight: 400;
    src: local('Cairo'), local('Cairo-Regular'), url(client/fonts/Cairo-Regular-Latin.woff2) format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  body {
    font-family: 'Cairo', sans-serif;
    background: black;
    color: white;
  }
  path {
    stroke: white;
    fill: white;
  }
  </style>
  <script type="text/javascript" src="client/vue.js"></script>
  <script type="text/javascript">
    function loadAsync(url) {
      return new Promise(function (resolve, reject) {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function(evt) {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              resolve(xhr.responseText);
            } else {
              resolve(null);
            }
          }
        }
        xhr.open('GET', url, true);
        xhr.send();
      });
    }

    loadAsync('client/icons/clear-day.svg').then(function(svg) {
      svg = svg.replace(/<\?.*>\s*/g, '');
      svg = svg.replace(/<!.*>\s*/g, '');
      console.log(svg);

      let div = document.createElement('div');
      div.innerHTML = svg;

      document.body.appendChild(div);
    });

    function App(websocketUrl, el) {
      this.websocketUrl = websocketUrl;
      this.el = el;
      this.app = null;
      this.open();
    }
    App.prototype.setResponse = function(response) {
      if (this.app) {
        this.app.respones = response;
        return;
      }

      this.app = new Vue({
        el: this.el,
        data: {
          response: response,
        },
      });
    }
    App.prototype.open = function() {
      this.ws = new WebSocket(this.websocketUrl);
      this.ws.onopen = App.prototype.onopen.bind(this);
    };
    App.prototype.onopen = function(e) {
      console.log('websocket opened');
      this.ws.onmessage = App.prototype.onmessage.bind(this);
      this.ws.onerror = App.prototype.onerror.bind(this);
      this.ws.onclose = App.prototype.onclose.bind(this);

      this.sendRequest('GET', '/');
    };
    App.prototype.onmessage = function(e) {
      this.setResponse(JSON.parse(e.data));
      console.log('message', this.app.response);
    };
    App.prototype.onerror = function(e) {
      console.log('error', e);
    };
    App.prototype.onclose = function(e) {
      setTimeout(function() { this.open(); }.bind(this), 100);
    };
    App.prototype.sendRequest = function(method, path, body) {
      this.ws.send(JSON.stringify({
        method: method,
        path: path,
        body: body
      }));
    };

    function load() {
      var app = new App('[[.WebsocketURL]]', '#template');
    }
  </script>
</head>
<body onload="load()">
  <div id="template">
    <div class="forecast">
      <span><img :src="'client/icons/' + response.forecast.icon + '.svg'"/></span>
      <span class="currentTemperature">{{Math.round(response.forecast.current)}}&deg;F</span>
      <span class="temperatureRange">{{Math.round(response.forecast.low)}}&deg;F - {{Math.round(response.forecast.high)}}&deg;F</span>
    </div>

    <div v-for="stream in response.streams">
      
    </div>
  </div>
  <h1>Mirror</h1>
</body>
</html>
